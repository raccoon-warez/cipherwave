<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CipherWave - Secure P2P Messenger</title>
    
    <!-- Fonts and Icons with fallbacks -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Critical CSS for immediate render -->
    <style>
        /* Critical CSS for above-the-fold content */
        :root {
            --primary: #5682a3;
            --primary-dark: #4a7290;
            --primary-light: #6b9bc1;
            --background: #ffffff;
            --sidebar: #f8fafc;
            --chat-bg: #f1f5f9;
            --message-received: #e2e8f0;
            --message-sent: #dbeafe;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            height: 100dvh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--background);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        /* Splash screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .splash-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* Font Awesome emoji fallbacks */
        .fa-lock:before, .fas.fa-lock:before { 
            content: "üîê"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-paper-plane:before, .fas.fa-paper-plane:before { 
            content: "üì§"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-plus:before, .fas.fa-plus:before { 
            content: "‚ûï"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-times:before, .fas.fa-times:before { 
            content: "‚ùå"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-dice:before, .fas.fa-dice:before { 
            content: "üé≤"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-plug:before, .fas.fa-plug:before { 
            content: "üîå"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-user:before, .fas.fa-user:before { 
            content: "üë§"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
        .fa-cog:before, .fas.fa-cog:before { 
            content: "‚öôÔ∏è"; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; 
        }
    </style>

    <!-- Link to external stylesheet for non-critical CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#5682a3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="cipherwave.png" as="image">
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splash-screen">
        <div class="splash-logo">üîê</div>
        <h1 class="splash-title">CipherWave</h1>
        <p class="splash-subtitle">Secure, Private Messaging</p>
    </div>

    <!-- Main App -->
    <div class="app-container hidden" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="./cipherwave.png" alt="User Avatar" onerror="this.style.display='none'; this.parentElement.classList.add('avatar-fallback');">
                        <span class="avatar-emoji">üë§</span>
                    </div>
                    <div class="user-details">
                        <div class="user-name">Anonymous User</div>
                        <div class="user-status">Offline</div>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="action-btn" id="new-chat-btn" title="New Chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="action-btn" id="settings-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="connection-indicator" id="connection-indicator">
                    <div class="status-dot"></div>
                    <span class="status-text">Disconnected</span>
                </div>
            </div>

            <div class="chat-list-container">
                <div class="chat-list" id="chat-list">
                    <!-- Chat items will be added here -->
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content" id="main-content">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">üîê</div>
                    <h2>Welcome to CipherWave</h2>
                    <p>Start a secure, encrypted conversation by connecting to a chat room.</p>
                    <button class="primary-btn" id="start-chat-btn">Start New Chat</button>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-interface hidden" id="chat-interface">
                <div class="chat-header">
                    <div class="contact-info">
                        <div class="contact-avatar">
                            <img src="./cipherwave.png" alt="Contact Avatar" onerror="this.style.display='none'; this.parentElement.classList.add('avatar-fallback');">
                            <span class="avatar-emoji">üí¨</span>
                        </div>
                        <div class="contact-details">
                            <div class="contact-name">Secure Chat</div>
                            <div class="contact-status" id="contact-status">Connecting...</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" title="Voice Call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="action-btn" title="Video Call">
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                </div>

                <div class="messages-container" id="messages-container">
                    <div class="encryption-notice">
                        <div class="notice-icon">üîê</div>
                        <p>Messages are end-to-end encrypted. Only you and your peer can read them.</p>
                    </div>
                </div>

                <div class="input-area">
                    <button class="attachment-btn" title="Attach File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="message-input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="message-input" 
                            placeholder="Type a message..."
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="send-btn" disabled title="Send Message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div class="modal-overlay" id="connection-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Join Secure Chat</h2>
                <button class="close-btn" id="close-modal" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="nickname">Your Nickname</label>
                    <input type="text" id="nickname" placeholder="Enter your nickname" value="Anonymous User" maxlength="30">
                </div>
                
                <div class="form-group">
                    <label for="room-id">Room ID</label>
                    <div class="input-group">
                        <input type="text" id="room-id" placeholder="Enter room ID" maxlength="50">
                        <button type="button" class="secondary-btn" id="generate-room">
                            <i class="fas fa-dice"></i> Generate
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="encryption-method">Encryption Method</label>
                    <select id="encryption-method">
                        <option value="aes-256">AES-256 (Recommended)</option>
                        <option value="chacha20">ChaCha20-Poly1305</option>
                    </select>
                </div>

                <button type="button" class="primary-btn full-width" id="connect-btn">
                    <i class="fas fa-plug"></i> Connect Securely
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay for connection -->
    <div class="loading-overlay hidden" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Establishing secure connection...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="fix-ui-elements.js"></script>
    <script src="script.js"></script>

    <!-- Application initialization -->
    <script>
        // Enhanced UI initialization with better error handling
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ CipherWave initializing...');
            
            // Initialize UI elements
            initializeUI();
            
            // Hide splash screen after initialization
            setTimeout(() => {
                hideSplashScreen();
            }, 2000);
        });

        function initializeUI() {
            // Set up event listeners
            setupEventListeners();
            
            // Initialize responsive behavior
            initializeResponsive();
            
            // Set up message input auto-resize
            setupMessageInput();
            
            console.log('‚úÖ UI initialized successfully');
        }

        function setupEventListeners() {
            // Modal controls
            const newChatBtn = document.getElementById('new-chat-btn');
            const startChatBtn = document.getElementById('start-chat-btn');
            const closeModal = document.getElementById('close-modal');
            const connectBtn = document.getElementById('connect-btn');
            const generateRoomBtn = document.getElementById('generate-room');

            if (newChatBtn) newChatBtn.addEventListener('click', showConnectionModal);
            if (startChatBtn) startChatBtn.addEventListener('click', showConnectionModal);
            if (closeModal) closeModal.addEventListener('click', hideConnectionModal);
            if (connectBtn) connectBtn.addEventListener('click', handleConnect);
            if (generateRoomBtn) generateRoomBtn.addEventListener('click', generateRoomId);

            // Message sending
            const sendBtn = document.getElementById('send-btn');
            const messageInput = document.getElementById('message-input');
            
            if (sendBtn) sendBtn.addEventListener('click', sendMessage);
            if (messageInput) {
                messageInput.addEventListener('keydown', handleMessageInputKeydown);
                messageInput.addEventListener('input', handleMessageInputChange);
            }
        }

        function initializeResponsive() {
            // Handle mobile sidebar toggle
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
            }

            window.addEventListener('resize', function() {
                if (window.innerWidth <= 768) {
                    document.body.classList.add('mobile');
                } else {
                    document.body.classList.remove('mobile');
                }
            });
        }

        function setupMessageInput() {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) return;

            messageInput.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Enable/disable send button
                const sendBtn = document.getElementById('send-btn');
                if (sendBtn) {
                    sendBtn.disabled = this.value.trim().length === 0;
                }
            });
        }

        function hideSplashScreen() {
            const splashScreen = document.getElementById('splash-screen');
            const appContainer = document.getElementById('app-container');
            
            if (splashScreen && appContainer) {
                splashScreen.style.opacity = '0';
                splashScreen.style.transform = 'scale(0.9)';
                
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    appContainer.style.opacity = '0';
                    appContainer.style.transform = 'translateY(20px)';
                    
                    // Animate app entrance
                    requestAnimationFrame(() => {
                        appContainer.style.transition = 'all 0.4s ease-out';
                        appContainer.style.opacity = '1';
                        appContainer.style.transform = 'translateY(0)';
                    });
                }, 300);
            }
        }

        function showConnectionModal() {
            const modal = document.getElementById('connection-modal');
            if (modal) {
                modal.classList.add('active');
                document.body.classList.add('modal-open');
                
                // Focus first input
                const nicknameInput = document.getElementById('nickname');
                if (nicknameInput) {
                    setTimeout(() => nicknameInput.focus(), 100);
                }
            }
        }

        function hideConnectionModal() {
            const modal = document.getElementById('connection-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.classList.remove('modal-open');
            }
        }

        function generateRoomId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let roomId = '';
            for (let i = 0; i < 16; i++) {
                roomId += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            const roomIdInput = document.getElementById('room-id');
            if (roomIdInput) {
                roomIdInput.value = roomId;
                
                // Visual feedback
                const generateBtn = document.getElementById('generate-room');
                if (generateBtn) {
                    const originalText = generateBtn.innerHTML;
                    generateBtn.innerHTML = '<i class="fas fa-check"></i> Generated';
                    generateBtn.disabled = true;
                    
                    setTimeout(() => {
                        generateBtn.innerHTML = originalText;
                        generateBtn.disabled = false;
                    }, 1500);
                }
            }
        }

        function handleConnect() {
            const roomId = document.getElementById('room-id')?.value?.trim();
            const nickname = document.getElementById('nickname')?.value?.trim();
            
            if (!roomId) {
                alert('Please enter a room ID');
                return;
            }
            
            if (!nickname) {
                alert('Please enter a nickname');
                return;
            }
            
            // Show loading state
            showLoadingOverlay();
            hideConnectionModal();
            
            // Simulate connection process (replace with actual WebRTC logic)
            setTimeout(() => {
                hideLoadingOverlay();
                showChatInterface();
                updateConnectionStatus('connected', 'Connected');
            }, 3000);
        }

        function showLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        function showChatInterface() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatInterface = document.getElementById('chat-interface');
            
            if (welcomeScreen && chatInterface) {
                welcomeScreen.classList.add('hidden');
                chatInterface.classList.remove('hidden');
            }
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('connection-indicator');
            const contactStatus = document.getElementById('contact-status');
            
            if (indicator) {
                indicator.className = `connection-indicator ${status}`;
                const statusText = indicator.querySelector('.status-text');
                if (statusText) statusText.textContent = text;
            }
            
            if (contactStatus) {
                contactStatus.textContent = status === 'connected' ? 'Online' : text;
            }
        }

        function handleMessageInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleMessageInputChange(event) {
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
                sendBtn.disabled = event.target.value.trim().length === 0;
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) return;
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add message to chat
            addMessageToChat(message, 'sent');
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Disable send button
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) sendBtn.disabled = true;
            
            // Focus back to input
            messageInput.focus();
        }

        function addMessageToChat(content, type) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageEl.innerHTML = `
                <div class="message-content">${escapeHtml(content)}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Global error handling
        window.addEventListener('error', function(event) {
            console.error('Application error:', event.error);
        });
    </script>
</body>
</html>